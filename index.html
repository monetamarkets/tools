<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>n8n æµç¨‹å¥åº·åº¦å„€è¡¨æ¿</title>
    <style>
        /* åŸºç¤æ¨£å¼ */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        
        /* Tag ç¯©é¸å™¨æ¨£å¼ */
        .filter-section { background-color: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tag-button { background-color: #bdc3c7; color: white; border: none; padding: 8px 15px; margin: 5px; border-radius: 20px; cursor: pointer; transition: background-color 0.3s; font-weight: bold; }
        .tag-button:hover { background-color: #95a5a6; }
        .tag-button.active { background-color: #3498db; }

        /* å¥åº·åº¦å¡ç‰‡æ¨£å¼ */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .health-card { background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.3s; }
        .health-card:hover { transform: translateY(-5px); }
        .card-header { font-size: 1.5em; margin-bottom: 10px; color: #2c3e50; }
        .card-value { font-size: 2.5em; font-weight: bold; margin-bottom: 5px; }
        .status-bar-container { background-color: #ecf0f1; border-radius: 4px; overflow: hidden; height: 15px; margin-top: 10px; }
        .status-bar { height: 100%; float: left; transition: width 0.5s ease-in-out; }
        
        /* ç‹€æ…‹é¡è‰² */
        .success { background-color: #2ecc71; }
        .error { background-color: #e74c3c; }
        .running { background-color: #f39c12; }

        /* è³‡è¨Šè¡¨æ ¼ */
        .workflow-table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .workflow-table th, .workflow-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        .workflow-table th { background-color: #34495e; color: white; font-weight: 600; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.9em; }
        .badge-success { background-color: #e8f8f5; color: #2ecc71; }
        .badge-error { background-color: #fdedec; color: #e74c3c; }
        .badge-running { background-color: #f9e79f; color: #f39c12; }
        .badge-active { background-color: #d1f2eb; color: #2ecc71; }
        .badge-inactive { background-color: #f4f6f7; color: #7f8c8d; }

        /* è¼‰å…¥ç‹€æ…‹ */
        #loading { text-align: center; padding: 50px; font-size: 1.2em; color: #7f8c8d; }

    </style>
</head>
<body>
    <div class="container">
        <h1>n8n æµç¨‹å¥åº·åº¦å„€è¡¨æ¿</h1>

        <div class="filter-section">
            <p><strong>Tag ç¯©é¸:</strong></p>
            <div id="tag-filters">
                </div>
            <p><strong>å…¶ä»–ç¯©é¸:</strong></p>
            <select id="status-filter">
                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                <option value="error">åƒ…éŒ¯èª¤</option>
                <option value="running">é‹è¡Œä¸­</option>
                <option value="success">æˆåŠŸ</option>
            </select>
            <select id="active-filter">
                <option value="">æ‰€æœ‰æµç¨‹</option>
                <option value="true">åƒ…å•Ÿç”¨</option>
                <option value="false">åƒ…åœç”¨</option>
            </select>
        </div>

        <h2>ä½¿ç”¨è€…æµç¨‹å¥åº·åº¦åˆ†æ</h2>
        <div id="health-dashboard" class="dashboard-grid">
            </div>

        <h2 id="workflow-list-header">æ‰€æœ‰æµç¨‹åˆ—è¡¨</h2>
        <div id="loading">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™... (æ­£åœ¨å‘¼å« Cloudflare Worker...)</div>
        <table id="workflow-table" class="workflow-table" style="display: none;">
            <thead>
                <tr>
                    <th>æµç¨‹åç¨±</th>
                    <th>æ‰€å±¬ Tag</th>
                    <th>å•Ÿç”¨ç‹€æ…‹</th>
                    <th>ä¸Šæ¬¡åŸ·è¡Œç‹€æ…‹</th>
                    <th>æˆåŠŸç‡ (ç¸½è¨ˆ)</th>
                    <th>ä¸Šæ¬¡åŸ·è¡Œæ™‚é–“</th>
                </tr>
            </thead>
            <tbody id="workflow-data">
                </tbody>
        </table>
    </div>

    <script>
        
        // ğŸš¨ æ›¿æ›è™• Aï¼šè«‹æ›¿æ›ç‚ºä½ éƒ¨ç½²æˆåŠŸå¾Œ Cloudflare çµ¦ä½ çš„ Worker ç¶²å€ ğŸš¨
        const WORKER_BASE_URL = 'https://n8n-proxy-worker.n8nproxytop10.workers.dev'; 
        // ç¯„ä¾‹: 'https://n8n-proxy-worker-monetamarkets.workers.dev'


        // é è¨­çš„ Tag æ•¸æ“š (åç¨±: ID)
        // ğŸš¨ æ›¿æ›è™• Bï¼šè«‹ç¢ºèªé€™äº› ID èˆ‡ä½ åœ¨ n8n ä¸­çš„å¯¦éš› Tag ID ä¸€è‡´ ğŸš¨
        const TAG_MAP = {
            'andy': 'FJBgIoARPYOnC7Qn',
            'peggy': 'kDYrLahBIPajtx3N',
            'alan': 'dRUR3H2kacyo6lAw'
        };

        let currentFilterTag = '';
        let allWorkflows = [];
        let allExecutions = [];

        // --- æ ¸å¿ƒ API å‘¼å«å‡½å¼ï¼šå¯¦éš›å‘¼å« Cloudflare Worker ---
        /**
         * å‘¼å« Cloudflare Worker ä»£ç†æœå‹™ä¾†ç²å–æ•¸æ“šã€‚
         * @param {string} endpoint - n8n API è·¯å¾‘ï¼ˆä¾‹å¦‚: '/workflows' æˆ– '/executions'ï¼‰
         * @param {object} params - æŸ¥è©¢åƒæ•¸
         * @returns {Promise<object>} - API å›æ‡‰æ•¸æ“š
         */
        async function fetchDataFromBackend(endpoint, params = {}) {
            // æ§‹é€ å®Œæ•´çš„ Worker URLï¼š WORKER_BASE_URL + /workflows + ?status=error
            const url = WORKER_BASE_URL + endpoint + '?' + new URLSearchParams(params);
            
            console.log(`Fetching from: ${url}`);
            
            const response = await fetch(url);
            
            if (!response.ok) {
                // å¦‚æœ Worker è¿”å›éŒ¯èª¤ï¼ˆä¾‹å¦‚ 403 Forbidden æˆ– 500 Server Errorï¼‰
                console.error(`Worker Response Error: ${response.status} ${response.statusText}`);
                const errorText = await response.text();
                console.error("Worker Error Detail:", errorText);
                throw new Error(`ç„¡æ³•å¾ Worker ç²å–æ•¸æ“šã€‚è«‹æª¢æŸ¥ Worker ç¶²å€å’Œ CORS è¨­å®š (${response.status})`);
            }
            
            return response.json();
        }
        
        // **æ³¨æ„ï¼šæ‰€æœ‰æ¨¡æ“¬æ•¸æ“šç”Ÿæˆå‡½å¼å·²è¢«ç§»é™¤ï¼Œä»¥ç¢ºä¿ç²å–çš„æ˜¯çœŸå¯¦æ•¸æ“šã€‚**

        /**
         * æ ¹æ“š Tag æ•¸æ“šè¨ˆç®—å¥åº·åº¦æŒ‡æ¨™ (æˆåŠŸç‡, éŒ¯èª¤æ•¸)
         */
        function analyzeHealthByTag(workflows, executions) {
            const results = {};

            for (const [userName, tagId] of Object.entries(TAG_MAP)) {
                // 1. ç¯©é¸å‡ºè©²ä½¿ç”¨è€… (Tag) çš„æ‰€æœ‰æµç¨‹ ID
                const userWorkflowIds = workflows
                    // æª¢æŸ¥ workflow.tags é™£åˆ—ä¸­æ˜¯å¦æœ‰ä»»ä¸€ tag çš„ id ç­‰æ–¼æˆ‘å€‘ç›®æ¨™çš„ tagId
                    .filter(w => w.tags && w.tags.some(t => t.id === tagId))
                    .map(w => w.id);

                // 2. ç¯©é¸å‡ºé€™äº›æµç¨‹çš„æ‰€æœ‰åŸ·è¡Œè¨˜éŒ„
                const userExecutions = executions.filter(e => userWorkflowIds.includes(e.workflowId));
                
                // 3. åŸ·è¡Œåˆ†æ
                const totalRuns = userExecutions.length;
                const successRuns = userExecutions.filter(e => e.status === 'success').length;
                const errorRuns = userExecutions.filter(e => e.status === 'error').length;
                const runningRuns = userExecutions.filter(e => e.status === 'running').length;
                const successRate = totalRuns > 0 ? (successRuns / totalRuns) * 100 : 0;
                
                results[userName] = {
                    totalWorkflows: userWorkflowIds.length,
                    totalRuns,
                    successRuns,
                    errorRuns,
                    runningRuns,
                    successRate: successRate.toFixed(1)
                };
            }
            return results;
        }

        /**
         * æ¸²æŸ“å¥åº·åº¦å¡ç‰‡
         */
        function renderHealthDashboard(healthData) {
            const dashboardEl = document.getElementById('health-dashboard');
            dashboardEl.innerHTML = '';

            for (const [userName, data] of Object.entries(healthData)) {
                const total = data.totalRuns || 1; // é¿å…é™¤ä»¥é›¶
                const successWidth = (data.successRuns / total) * 100;
                const errorWidth = (data.errorRuns / total) * 100;
                const runningWidth = (data.runningRuns / total) * 100;
                
                dashboardEl.innerHTML += `
                    <div class="health-card">
                        <div class="card-header">${userName} çš„æµç¨‹æ¦‚è¦½ (${data.totalWorkflows} å€‹æµç¨‹)</div>
                        <div class="card-value ${data.successRate < 80 ? 'error' : 'success'}">${data.successRate}%</div>
                        <p>ç¸½åŸ·è¡Œæ¬¡æ•¸: ${data.totalRuns}</p>
                        <p>éŒ¯èª¤æ¬¡æ•¸: <strong class="error">${data.errorRuns}</strong></p>
                        <div class="status-bar-container">
                            <div class="status-bar success" style="width: ${successWidth}%;"></div>
                            <div class="status-bar error" style="width: ${errorWidth}%;"></div>
                            <div class="status-bar running" style="width: ${runningWidth}%;"></div>
                        </div>
                        <small>ç¶ è‰²: æˆåŠŸ, ç´…è‰²: éŒ¯èª¤, é»ƒè‰²: é‹è¡Œä¸­</small>
                    </div>
                `;
            }
        }

        /**
         * æ¸²æŸ“æµç¨‹åˆ—è¡¨
         * @param {string} tag - ç•¶å‰é¸ä¸­çš„ Tag åç¨±
         * @param {string} status - ç•¶å‰é¸ä¸­çš„ç‹€æ…‹ç¯©é¸
         * @param {string} active - ç•¶å‰é¸ä¸­çš„å•Ÿç”¨ç‹€æ…‹ç¯©é¸
         */
        function renderWorkflowList(tag = '', status = '', active = '') {
            const tableBody = document.getElementById('workflow-data');
            tableBody.innerHTML = '';

            let filteredWorkflows = allWorkflows;

            // 1. Tag ç¯©é¸
            if (tag && tag !== 'all') {
                const tagId = TAG_MAP[tag];
                filteredWorkflows = filteredWorkflows.filter(w => w.tags && w.tags.some(t => t.id === tagId));
                document.getElementById('workflow-list-header').textContent = `${tag} çš„æµç¨‹åˆ—è¡¨`;
            } else {
                document.getElementById('workflow-list-header').textContent = `æ‰€æœ‰æµç¨‹åˆ—è¡¨`;
            }

            // 2. å•Ÿç”¨ç‹€æ…‹ç¯©é¸
            if (active !== '') {
                const isActive = active === 'true';
                filteredWorkflows = filteredWorkflows.filter(w => w.active === isActive);
            }

            // 3. ç‹€æ…‹ç¯©é¸ (æ³¨æ„ï¼šæˆ‘å€‘ä½¿ç”¨ lastExecutionStatus ä½œç‚ºç¯©é¸åŸºç¤ï¼Œé€™å¯èƒ½ä¸å¤ ç²¾ç¢º)
            if (status !== '') {
                // æˆ‘å€‘éœ€è¦ä¸€å€‹æœ‰æ•ˆçš„æ–¹æ³•ä¾†å–å¾—æ¯å€‹æµç¨‹çš„æœ€æ–°ç‹€æ…‹
                filteredWorkflows = filteredWorkflows.filter(workflow => {
                    const latestExecution = allExecutions
                        .filter(e => e.workflowId === workflow.id)
                        .sort((a, b) => new Date(b.startedAt) - new Date(a.startedAt))[0];
                    return latestExecution && latestExecution.status === status;
                });
            }


            if (filteredWorkflows.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„æµç¨‹æ•¸æ“šã€‚</td></tr>';
                return;
            }

            filteredWorkflows.forEach(workflow => {
                // æ‰¾åˆ°è©²æµç¨‹çš„æœ€æ–°åŸ·è¡Œè¨˜éŒ„
                const workflowExecutions = allExecutions.filter(e => e.workflowId === workflow.id);
                
                // æ’åºä»¥å–å¾—æœ€æ–°è¨˜éŒ„
                workflowExecutions.sort((a, b) => new Date(b.startedAt) - new Date(a.startedAt));
                
                const totalRuns = workflowExecutions.length;
                const successRuns = workflowExecutions.filter(e => e.status === 'success').length;
                const successRate = totalRuns > 0 ? (successRuns / totalRuns * 100).toFixed(1) : 'N/A';
                
                const lastRun = workflowExecutions[0]; 
                const lastRunStatus = lastRun ? lastRun.status : 'N/A';
                const lastRunTime = lastRun ? new Date(lastRun.startedAt).toLocaleString() : 'ç„¡è¨˜éŒ„';
                
                const statusClass = {
                    'success': 'badge-success',
                    'error': 'badge-error',
                    'running': 'badge-running',
                    'waiting': 'badge-running', // Waiting ä¹Ÿè¦–ç‚ºæ­£åœ¨è™•ç†ä¸­
                    'N/A': 'badge-inactive'
                }[lastRunStatus || 'N/A'];

                const activeBadge = workflow.active 
                    ? `<span class="status-badge badge-active">å•Ÿç”¨ä¸­</span>` 
                    : `<span class="status-badge badge-inactive">å·²åœç”¨</span>`;

                const tagsDisplay = workflow.tags ? workflow.tags.map(t => t.name).join(', ') : 'ç„¡';

                tableBody.innerHTML += `
                    <tr>
                        <td>${workflow.name}</td>
                        <td>${tagsDisplay}</td>
                        <td>${activeBadge}</td>
                        <td><span class="status-badge ${statusClass}">${lastRunStatus}</span></td>
                        <td>${successRate}%</td>
                        <td>${lastRunTime}</td>
                    </tr>
                `;
            });
        }

        /**
         * æ¸²æŸ“ Tag ç¯©é¸æŒ‰éˆ•
         */
        function renderTagFilters() {
            const filterContainer = document.getElementById('tag-filters');
            filterContainer.innerHTML = '';
            
            // åŠ å…¥ "å…¨éƒ¨" æŒ‰éˆ•
            filterContainer.innerHTML += `
                <button class="tag-button active" data-tag-name="all">å…¨éƒ¨æµç¨‹</button>
            `;

            // åŠ å…¥æ¯å€‹ä½¿ç”¨è€… Tag æŒ‰éˆ•
            for (const name of Object.keys(TAG_MAP)) {
                filterContainer.innerHTML += `
                    <button class="tag-button" data-tag-name="${name}">${name}</button>
                `;
            }
        }

        /**
         * è™•ç†ç¯©é¸å™¨é»æ“Šäº‹ä»¶ (Tag, ç‹€æ…‹, å•Ÿç”¨ç‹€æ…‹)
         */
        function handleFilterChange() {
            const statusFilter = document.getElementById('status-filter').value;
            const activeFilter = document.getElementById('active-filter').value;
            
            // é‡æ–°æ¸²æŸ“æµç¨‹åˆ—è¡¨
            renderWorkflowList(currentFilterTag, statusFilter, activeFilter);
        }

        /**
         * å„€è¡¨æ¿å•Ÿå‹•å‡½å¼
         */
        async function initDashboard() {
            try {
                // 1. å–å¾—æ‰€æœ‰æµç¨‹å’ŒåŸ·è¡Œè¨˜éŒ„ 
                document.getElementById('loading').style.display = 'block';
                
                // å‘¼å« Worker å–å¾—æ‰€æœ‰ Workflows
                const workflowsResponse = await fetchDataFromBackend('/workflows');
                allWorkflows = workflowsResponse.data || [];
                
                // å‘¼å« Worker å–å¾—æ‰€æœ‰ Executions
                // æ³¨æ„ï¼šå¦‚æœæ‚¨çš„åŸ·è¡Œè¨˜éŒ„éå¸¸å¤šï¼Œé€™è£¡å¯èƒ½éœ€è¦åˆ†é è™•ç†
                const executionsResponse = await fetchDataFromBackend('/executions?includeData=false&limit=250');
                allExecutions = executionsResponse.data || [];
                
                // ç”±æ–¼æˆ‘å€‘éœ€è¦ä¾æ“šåŸ·è¡Œæ™‚é–“ä¾†æ’åºå’Œè¨ˆç®—ï¼Œå…ˆåœ¨æœ¬åœ°æ’åºä¸€æ¬¡ï¼Œç¢ºä¿æœ€æ–°çš„åŸ·è¡Œåœ¨æœ€å‰é¢
                allExecutions.sort((a, b) => new Date(b.startedAt) - new Date(a.startedAt));


                document.getElementById('loading').style.display = 'none';
                document.getElementById('workflow-table').style.display = 'table';

                // 2. æ ¹æ“š Tag é€²è¡Œå¥åº·åº¦åˆ†æ
                const healthData = analyzeHealthByTag(allWorkflows, allExecutions);
                renderHealthDashboard(healthData);

                // 3. æ¸²æŸ“ Tag ç¯©é¸å™¨
                renderTagFilters();
                
                // 4. åˆå§‹æ¸²æŸ“æµç¨‹åˆ—è¡¨
                renderWorkflowList('all');

                // 5. ç¶å®šäº‹ä»¶ç›£è½å™¨
                document.querySelectorAll('#tag-filters .tag-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        // æ›´æ–° Tag ç¯©é¸ç‹€æ…‹
                        document.querySelectorAll('#tag-filters .tag-button').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        currentFilterTag = e.target.dataset.tagName === 'all' ? '' : e.target.dataset.tagName;
                        handleFilterChange();
                    });
                });

                document.getElementById('status-filter').addEventListener('change', handleFilterChange);
                document.getElementById('active-filter').addEventListener('change', handleFilterChange);

            } catch (error) {
                console.error("åˆå§‹åŒ–å„€è¡¨æ¿å¤±æ•—:", error);
                document.getElementById('loading').textContent = `è¼‰å…¥æ•¸æ“šå¤±æ•—: ${error.message}ã€‚è«‹æª¢æŸ¥ Worker ç¶²å€å’Œ n8n å¯¦ä¾‹ç‹€æ…‹ã€‚`;
            }
        }

        // å•Ÿå‹•å„€è¡¨æ¿
        initDashboard();
    </script>
</body>
</html>