<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>n8n æµç¨‹å¥åº·åº¦å„€è¡¨æ¿</title>
    <style>
        /* åŸºç¤æ¨£å¼ */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        
        /* Tag ç¯©é¸å™¨æ¨£å¼ */
        .filter-section { background-color: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tag-button { background-color: #bdc3c7; color: white; border: none; padding: 8px 15px; margin: 5px; border-radius: 20px; cursor: pointer; transition: background-color 0.3s; font-weight: bold; }
        .tag-button:hover { background-color: #95a5a6; }
        .tag-button.active { background-color: #3498db; }

        /* å¥åº·åº¦å¡ç‰‡æ¨£å¼ */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .health-card { background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.3s; }
        .health-card:hover { transform: translateY(-5px); }
        .card-header { font-size: 1.5em; margin-bottom: 10px; color: #2c3e50; }
        .card-value { font-size: 2.5em; font-weight: bold; margin-bottom: 5px; }
        .status-bar-container { background-color: #ecf0f1; border-radius: 4px; overflow: hidden; height: 15px; margin-top: 10px; }
        .status-bar { height: 100%; float: left; transition: width 0.5s ease-in-out; }
        
        /* ç‹€æ…‹é¡è‰² */
        .success { background-color: #2ecc71; }
        .error { background-color: #e74c3c; }
        .running { background-color: #f39c12; }

        /* è³‡è¨Šè¡¨æ ¼ */
        .workflow-table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .workflow-table th, .workflow-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        .workflow-table th { background-color: #34495e; color: white; font-weight: 600; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.9em; }
        .badge-success { background-color: #e8f8f5; color: #2ecc71; }
        .badge-error { background-color: #fdedec; color: #e74c3c; }
        .badge-running { background-color: #f9e79f; color: #f39c12; }
        .badge-active { background-color: #d1f2eb; color: #2ecc71; }
        .badge-inactive { background-color: #f4f6f7; color: #7f8c8d; }

        /* è¼‰å…¥ç‹€æ…‹ */
        #loading { text-align: center; padding: 50px; font-size: 1.2em; color: #7f8c8d; }

    </style>
</head>
<body>
    <div class="container">
        <h1>n8n æµç¨‹å¥åº·åº¦å„€è¡¨æ¿</h1>

        <div class="filter-section">
            <p><strong>Tag ç¯©é¸:</strong></p>
            <div id="tag-filters">
                </div>
            <p><strong>å…¶ä»–ç¯©é¸:</strong></p>
            <select id="status-filter">
                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                <option value="error">åƒ…éŒ¯èª¤</option>
                <option value="running">é‹è¡Œä¸­</option>
                <option value="success">æˆåŠŸ</option>
            </select>
            <select id="active-filter">
                <option value="">æ‰€æœ‰æµç¨‹</option>
                <option value="true">åƒ…å•Ÿç”¨</option>
                <option value="false">åƒ…åœç”¨</option>
            </select>
        </div>

        <h2>ä½¿ç”¨è€…æµç¨‹å¥åº·åº¦åˆ†æ</h2>
        <div id="health-dashboard" class="dashboard-grid">
            </div>

        <h2 id="workflow-list-header">æ‰€æœ‰æµç¨‹åˆ—è¡¨</h2>
        <div id="loading">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™... (æ­¤ç‚ºæ¨¡æ“¬æ•¸æ“š)</div>
        <table id="workflow-table" class="workflow-table" style="display: none;">
            <thead>
                <tr>
                    <th>æµç¨‹åç¨±</th>
                    <th>æ‰€å±¬ Tag</th>
                    <th>å•Ÿç”¨ç‹€æ…‹</th>
                    <th>ä¸Šæ¬¡åŸ·è¡Œç‹€æ…‹</th>
                    <th>æˆåŠŸç‡ (ç¸½è¨ˆ)</th>
                    <th>ä¸Šæ¬¡åŸ·è¡Œæ™‚é–“</th>
                </tr>
            </thead>
            <tbody id="workflow-data">
                </tbody>
        </table>
    </div>

    <script>
        // ğŸš¨ã€è³‡å®‰æé†’ã€‘: é€™æ˜¯å‰ç«¯ JavaScriptã€‚
        // åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæ‚¨**çµ•å°ä¸èƒ½**å°‡ n8n API Key æ”¾åœ¨é€™è£¡ã€‚
        // ä»¥ä¸‹çš„ `fetchDataFromBackend` å‡½æ•¸æ˜¯**æ¨¡æ“¬**å‘æ‚¨å®‰å…¨çš„å¾Œç«¯ä»£ç†æœå‹™ç™¼å‡ºè«‹æ±‚ã€‚

        // é è¨­çš„ Tag æ•¸æ“š (åç¨±: ID)
        const TAG_MAP = {
            'andy': 'FJBgIoARPYOnC7Qn',
            'peggy': 'kDYrLahBIPajtx3N',
            'alan': 'dRUR3H2kacyo6lAw'
        };

        let currentFilterTag = '';
        let allWorkflows = [];
        let allExecutions = [];

        // --- æ¨¡æ“¬å¾Œç«¯ API å‘¼å« ---
        /**
         * æ¨¡æ“¬å‘¼å«å¾Œç«¯ä»£ç†æœå‹™ä¾†ç²å–æ•¸æ“šã€‚
         * åœ¨å¯¦éš›ç’°å¢ƒä¸­ï¼Œæ‚¨æœƒå‘¼å«è‡ªå·±çš„å®‰å…¨å¾Œç«¯ URLï¼Œ
         * å¾Œç«¯å†ä½¿ç”¨ n8n API Key å‘ n8n å¯¦ä¾‹è«‹æ±‚æ•¸æ“šã€‚
         * @param {string} endpoint - æ¨¡æ“¬çš„ n8n API è·¯å¾‘ï¼ˆä¾‹å¦‚: '/workflows'ï¼‰
         * @param {object} params - æŸ¥è©¢åƒæ•¸
         * @returns {Promise<object>} - æ¨¡æ“¬çš„ API å›æ‡‰æ•¸æ“š
         */
        async function fetchDataFromBackend(endpoint, params = {}) {
            // åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™è£¡æ‡‰è©²æ˜¯:
            // const url = `/your-backend-proxy${endpoint}?${new URLSearchParams(params)}`;
            // const response = await fetch(url);
            // return response.json();

            // ğŸ“¢ é€™è£¡ä½¿ç”¨æ¨¡æ“¬æ•¸æ“šï¼š
            const MOCK_DATA = generateMockData();
            await new Promise(resolve => setTimeout(resolve, 800)); // æ¨¡æ“¬ç¶²è·¯å»¶é²

            if (endpoint.startsWith('/workflows')) {
                let data = MOCK_DATA.workflows;
                // æ¨¡æ“¬ Tag ç¯©é¸
                if (params.tags) {
                    const tagId = TAG_MAP[params.tags.toLowerCase()];
                    data = data.filter(w => w.tags.some(t => t.id === tagId));
                }
                // æ¨¡æ“¬å•Ÿç”¨/åœç”¨ç¯©é¸
                if (params.active !== undefined) {
                    const isActive = params.active === 'true';
                    data = data.filter(w => w.active === isActive);
                }
                return { data: data };
            } else if (endpoint.startsWith('/executions')) {
                let data = MOCK_DATA.executions;
                // æ¨¡æ“¬ç‹€æ…‹ç¯©é¸
                if (params.status) {
                    data = data.filter(e => e.status === params.status);
                }
                // æ¨¡æ“¬ Workflow ç¯©é¸
                if (params.workflowId) {
                    const id = parseInt(params.workflowId);
                    data = data.filter(e => e.workflowId === id);
                }
                // æ¨¡æ“¬åªè¿”å›æœ€æ–°çš„åŸ·è¡Œ (æœ€ç›¸é—œçš„æ•¸æ“š)
                data.sort((a, b) => new Date(b.stoppedAt) - new Date(a.stoppedAt));
                return { data: data };
            }

            return {};
        }
        // --- æ¨¡æ“¬æ•¸æ“šç”Ÿæˆå‡½å¼ (åƒ…ç”¨æ–¼å‰ç«¯å±•ç¤º) ---
        function generateMockData() {
            const statuses = ['success', 'error', 'running'];
            const names = ['å ±è¡¨è‡ªå‹•åŒ–', 'æ¯æ—¥è³‡æ–™åŒæ­¥', 'å®¢æˆ¶é€šçŸ¥', 'ç³»çµ±ç›£æ§', 'æ’ç¨‹å‚™ä»½'];
            const workflows = [];
            const executions = [];

            // ç”¢ç”Ÿæµç¨‹ (workflows)
            let workflowId = 1000;
            for (const [name, id] of Object.entries(TAG_MAP)) {
                for (let i = 0; i < 3; i++) {
                    workflows.push({
                        id: workflowId,
                        name: `${name}'s ${names[i]}`,
                        active: Math.random() > 0.2,
                        tags: [{ id: id, name: name }],
                        lastExecutionStatus: Math.random() < 0.8 ? 'success' : 'error' // æ¨¡æ“¬ä¸Šæ¬¡åŸ·è¡Œç‹€æ…‹
                    });
                    workflowId++;
                }
            }
            // ç”¢ç”Ÿé¡å¤–çš„ç„¡ Tag æµç¨‹
            for (let i = 0; i < 3; i++) {
                workflows.push({
                    id: workflowId,
                    name: names[i + 2],
                    active: Math.random() > 0.5,
                    tags: [],
                    lastExecutionStatus: Math.random() < 0.7 ? 'success' : 'running'
                });
                workflowId++;
            }
            
            // ç”¢ç”ŸåŸ·è¡Œè¨˜éŒ„ (executions)
            for (let id = 1; id <= 100; id++) {
                const randomWorkflow = workflows[Math.floor(Math.random() * workflows.length)];
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const stoppedAt = new Date(Date.now() - Math.floor(Math.random() * 24 * 3600 * 1000));
                const startedAt = new Date(stoppedAt - 10000);

                executions.push({
                    id: id,
                    workflowId: randomWorkflow.id,
                    status: status,
                    startedAt: startedAt.toISOString(),
                    stoppedAt: status === 'running' ? null : stoppedAt.toISOString()
                });
            }

            return { workflows, executions };
        }
        // --- æ ¸å¿ƒé‚è¼¯å‡½å¼ ---

        /**
         * æ ¹æ“š Tag æ•¸æ“šè¨ˆç®—å¥åº·åº¦æŒ‡æ¨™ (æˆåŠŸç‡, éŒ¯èª¤æ•¸)
         */
        function analyzeHealthByTag(workflows, executions) {
            const results = {};

            for (const [userName, tagId] of Object.entries(TAG_MAP)) {
                // 1. ç¯©é¸å‡ºè©²ä½¿ç”¨è€… (Tag) çš„æ‰€æœ‰æµç¨‹ ID
                const userWorkflowIds = workflows
                    .filter(w => w.tags.some(t => t.id === tagId))
                    .map(w => w.id);

                // 2. ç¯©é¸å‡ºé€™äº›æµç¨‹çš„æ‰€æœ‰åŸ·è¡Œè¨˜éŒ„
                const userExecutions = executions.filter(e => userWorkflowIds.includes(e.workflowId));

                // 3. åŸ·è¡Œåˆ†æ
                const totalRuns = userExecutions.length;
                const successRuns = userExecutions.filter(e => e.status === 'success').length;
                const errorRuns = userExecutions.filter(e => e.status === 'error').length;
                const runningRuns = userExecutions.filter(e => e.status === 'running').length;
                const successRate = totalRuns > 0 ? (successRuns / totalRuns) * 100 : 0;
                
                results[userName] = {
                    totalWorkflows: userWorkflowIds.length,
                    totalRuns,
                    successRuns,
                    errorRuns,
                    runningRuns,
                    successRate: successRate.toFixed(1)
                };
            }
            return results;
        }

        /**
         * æ¸²æŸ“å¥åº·åº¦å¡ç‰‡
         */
        function renderHealthDashboard(healthData) {
            const dashboardEl = document.getElementById('health-dashboard');
            dashboardEl.innerHTML = '';

            for (const [userName, data] of Object.entries(healthData)) {
                const total = data.totalRuns;
                const successWidth = total > 0 ? (data.successRuns / total) * 100 : 0;
                const errorWidth = total > 0 ? (data.errorRuns / total) * 100 : 0;
                const runningWidth = total > 0 ? (data.runningRuns / total) * 100 : 0;
                
                dashboardEl.innerHTML += `
                    <div class="health-card">
                        <div class="card-header">${userName} çš„æµç¨‹æ¦‚è¦½ (${data.totalWorkflows} å€‹æµç¨‹)</div>
                        <div class="card-value ${data.successRate < 80 ? 'error' : 'success'}">${data.successRate}%</div>
                        <p>ç¸½åŸ·è¡Œæ¬¡æ•¸: ${data.totalRuns}</p>
                        <p>éŒ¯èª¤æ¬¡æ•¸: <strong class="error">${data.errorRuns}</strong></p>
                        <div class="status-bar-container">
                            <div class="status-bar success" style="width: ${successWidth}%;"></div>
                            <div class="status-bar error" style="width: ${errorWidth}%;"></div>
                            <div class="status-bar running" style="width: ${runningWidth}%;"></div>
                        </div>
                        <small>ç¶ è‰²: æˆåŠŸ, ç´…è‰²: éŒ¯èª¤, é»ƒè‰²: é‹è¡Œä¸­</small>
                    </div>
                `;
            }
        }

        /**
         * æ¸²æŸ“æµç¨‹åˆ—è¡¨
         * @param {string} tag - ç•¶å‰é¸ä¸­çš„ Tag åç¨±
         * @param {string} status - ç•¶å‰é¸ä¸­çš„ç‹€æ…‹ç¯©é¸
         * @param {string} active - ç•¶å‰é¸ä¸­çš„å•Ÿç”¨ç‹€æ…‹ç¯©é¸
         */
        function renderWorkflowList(tag = '', status = '', active = '') {
            const tableBody = document.getElementById('workflow-data');
            tableBody.innerHTML = '';

            let filteredWorkflows = allWorkflows;

            // 1. Tag ç¯©é¸
            if (tag && tag !== 'all') {
                const tagId = TAG_MAP[tag];
                filteredWorkflows = filteredWorkflows.filter(w => w.tags.some(t => t.id === tagId));
                document.getElementById('workflow-list-header').textContent = `${tag} çš„æµç¨‹åˆ—è¡¨`;
            } else {
                document.getElementById('workflow-list-header').textContent = `æ‰€æœ‰æµç¨‹åˆ—è¡¨`;
            }

            // 2. å•Ÿç”¨ç‹€æ…‹ç¯©é¸
            if (active !== '') {
                const isActive = active === 'true';
                filteredWorkflows = filteredWorkflows.filter(w => w.active === isActive);
            }

            // 3. ç‹€æ…‹ç¯©é¸ (æ³¨æ„ï¼šé€™éœ€è¦åœ¨å¾Œç«¯å‘¼å« `/executions` ä¾†éæ¿¾)
            // åœ¨æ­¤æ¨¡æ“¬ä¸­ï¼Œæˆ‘å€‘å‡è¨­ `lastExecutionStatus` å¯ä»¥è¢«ç¯©é¸
            if (status !== '') {
                filteredWorkflows = filteredWorkflows.filter(w => w.lastExecutionStatus === status);
            }


            if (filteredWorkflows.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„æµç¨‹æ•¸æ“šã€‚</td></tr>';
                return;
            }

            filteredWorkflows.forEach(workflow => {
                // æ¨¡æ“¬è¨ˆç®—æˆåŠŸç‡å’Œä¸Šæ¬¡åŸ·è¡Œæ™‚é–“ (å¯¦éš›æ‡‰å¾ executions æ•¸æ“šè¨ˆç®—)
                const workflowExecutions = allExecutions.filter(e => e.workflowId === workflow.id);
                const totalRuns = workflowExecutions.length;
                const successRuns = workflowExecutions.filter(e => e.status === 'success').length;
                const successRate = totalRuns > 0 ? (successRuns / totalRuns * 100).toFixed(1) : 'N/A';
                
                const lastRun = workflowExecutions[0]; // æ¨¡æ“¬å·²æ’åºçš„æœ€æ–°åŸ·è¡Œ
                const lastRunTime = lastRun ? new Date(lastRun.startedAt).toLocaleString() : 'ç„¡è¨˜éŒ„';
                
                const statusClass = {
                    'success': 'badge-success',
                    'error': 'badge-error',
                    'running': 'badge-running',
                    'N/A': 'badge-inactive'
                }[workflow.lastExecutionStatus || 'N/A'];

                const activeBadge = workflow.active 
                    ? `<span class="status-badge badge-active">å•Ÿç”¨ä¸­</span>` 
                    : `<span class="status-badge badge-inactive">å·²åœç”¨</span>`;

                const tagsDisplay = workflow.tags.map(t => t.name).join(', ') || 'ç„¡';

                tableBody.innerHTML += `
                    <tr>
                        <td>${workflow.name}</td>
                        <td>${tagsDisplay}</td>
                        <td>${activeBadge}</td>
                        <td><span class="status-badge ${statusClass}">${workflow.lastExecutionStatus || 'N/A'}</span></td>
                        <td>${successRate}%</td>
                        <td>${lastRunTime}</td>
                    </tr>
                `;
            });
        }

        /**
         * æ¸²æŸ“ Tag ç¯©é¸æŒ‰éˆ•
         */
        function renderTagFilters() {
            const filterContainer = document.getElementById('tag-filters');
            filterContainer.innerHTML = '';
            
            // åŠ å…¥ "å…¨éƒ¨" æŒ‰éˆ•
            filterContainer.innerHTML += `
                <button class="tag-button active" data-tag-name="all">å…¨éƒ¨æµç¨‹</button>
            `;

            // åŠ å…¥æ¯å€‹ä½¿ç”¨è€… Tag æŒ‰éˆ•
            for (const name of Object.keys(TAG_MAP)) {
                filterContainer.innerHTML += `
                    <button class="tag-button" data-tag-name="${name}">${name}</button>
                `;
            }
        }

        /**
         * è™•ç†ç¯©é¸å™¨é»æ“Šäº‹ä»¶ (Tag, ç‹€æ…‹, å•Ÿç”¨ç‹€æ…‹)
         */
        function handleFilterChange() {
            const statusFilter = document.getElementById('status-filter').value;
            const activeFilter = document.getElementById('active-filter').value;
            
            // é‡æ–°æ¸²æŸ“æµç¨‹åˆ—è¡¨
            renderWorkflowList(currentFilterTag, statusFilter, activeFilter);
        }

        /**
         * å„€è¡¨æ¿å•Ÿå‹•å‡½å¼
         */
        async function initDashboard() {
            try {
                // 1. å–å¾—æ‰€æœ‰æµç¨‹å’ŒåŸ·è¡Œè¨˜éŒ„ (æ¨¡æ“¬å¾Œç«¯å¤šå€‹ API å‘¼å«)
                document.getElementById('loading').style.display = 'block';
                
                const workflowsResponse = await fetchDataFromBackend('/workflows');
                allWorkflows = workflowsResponse.data || [];
                
                const executionsResponse = await fetchDataFromBackend('/executions');
                allExecutions = executionsResponse.data || [];

                document.getElementById('loading').style.display = 'none';
                document.getElementById('workflow-table').style.display = 'table';

                // 2. æ ¹æ“š Tag é€²è¡Œå¥åº·åº¦åˆ†æ
                const healthData = analyzeHealthByTag(allWorkflows, allExecutions);
                renderHealthDashboard(healthData);

                // 3. æ¸²æŸ“ Tag ç¯©é¸å™¨
                renderTagFilters();
                
                // 4. åˆå§‹æ¸²æŸ“æµç¨‹åˆ—è¡¨
                renderWorkflowList('all');

                // 5. ç¶å®šäº‹ä»¶ç›£è½å™¨
                document.querySelectorAll('#tag-filters .tag-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        // æ›´æ–° Tag ç¯©é¸ç‹€æ…‹
                        document.querySelectorAll('#tag-filters .tag-button').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        currentFilterTag = e.target.dataset.tagName === 'all' ? '' : e.target.dataset.tagName;
                        handleFilterChange();
                    });
                });

                document.getElementById('status-filter').addEventListener('change', handleFilterChange);
                document.getElementById('active-filter').addEventListener('change', handleFilterChange);

            } catch (error) {
                console.error("åˆå§‹åŒ–å„€è¡¨æ¿å¤±æ•—:", error);
                document.getElementById('loading').textContent = 'è¼‰å…¥æ•¸æ“šå¤±æ•—ã€‚è«‹æª¢æŸ¥å¾Œç«¯æœå‹™å’Œ API Key é…ç½®ã€‚';
            }
        }

        // å•Ÿå‹•å„€è¡¨æ¿
        initDashboard();
    </script>
</body>
</html>